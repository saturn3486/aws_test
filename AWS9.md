## 触って学ぶクラウドインフラAWS　Appendix

### ネットワークの管理・運用

ネットワークに問題が発生した時の原因の発見や対処、その後の再発防止のためには

- 構成の把握
- 状態の監視

が必要。

例えば、

**新たにサービスを拡張する場合**

リソースの追加が必要かどうか？→ネットワークの監視が必要。通信容量やデータベースのキャパなどを監視しておく必要が有る。

どこにどれだけのリソースを配置するか？→ネットワークの構成情報の把握が必要。変な所に追加してしまうと、後々問題が再発する。


ネットワークは、システムの中でも基板に近い。
その上に配置されるアプリの要求によって、柔軟に変更や追加が可能であるべき。


新たにビジネスを進めるときに、ネットワークがボトルネックとなって、開発や改修が遅れてしまわないよう、しっかりと構成や状態を把握しておくこと。  
→Webサイト運用だと、どこらへんに問題が起こるかな？  
→Webサービスならこれは常に余裕を持たせたいところ。ユーザ数に応じてスムーズなスケールが可能な設計に出来るとOK.  
→まさにAmazon Web Serviceの良いところ笑


#### ネットワーク構成の把握

把握しておくべき要素
- ネットワーク全体のトポロジ（構成図）
- ネットワークに割り当てられているIPアドレスブロック
- ネットワーク内に存在するサブネットとそれぞれのIPアドレスブロック
- 各サブネット内に存在するインスタンス
- インスタンスが持つプライベートIPアドレスとパブリックIPアドレス
- それぞれのインスタンスの役割と、動いているアプリケーションまたはプロセス
- ルートテーブルの設定
- セキュリティグループやネットワークACLの設定

> ネットワークACLって？→Access Control Listの着。アクセス権限の設定。

更に、AWSでない物理的な環境ならば、次の項目も宜しく！
- ネットワークに配置されているスイッチやルーターなどのネットワーク機器
- 自分たちで管理しているパブリックIPアドレスの一覧と利用状況


まだまだ把握しておいてほしい情報はあるけど、上記の情報が重要！  
そしてそれだけでも大変！頑張って。

##### ドキュメントと構成情報を一致させる工夫

これらの情報は、ドキュメント化して管理することになる。
IPアドレスやセキュリティの設定はExcelで。
ネットワークトポロジはPowerPointやVisioで。

実際に運用する場面では、各サーバやネットワーク機器にログイン、ドキュメント通りに設定していきます。
アップデート時は、それぞれログインして、アップデートし、ドキュメントを修正していきます。

ドキュメントの修正を怠ると、何が最新か解らなくなり、現場が混乱します笑

しかし、ドキュメントに記載してからサーバ等を設定するのは実際二度手間であり、大変。

そこで！


この手順を自動化出来る方法が有ります！

##### デプロイツールの利用

テキスト形式の設定ファイル通りにサーバのアップデート等を自動で行ってくれるもので、
- Chef
- Puppet

などのツールが有名です。

テキスト形式の設定ファイルは人間が読めますし、見づらいようならただのテキストなので、整形スクリプトを適当に組めばOKです。

ただし！

ChefやPuppetが適用できるのは、多くの場合は、サーバの設定だけ。
ネットワーク危機は実は厳しい。

なぜなら！

ネットワーク機器をコントロールする統一された方法が無いからです。。。

##### AWSならこんなことも

このような状況はAWSを利用すると少し改善されます。
AWSでは
- サブネットのCIDRブロック
- セキュリティグループ
- ネットワークACLの設定
- ホストのIPアドレス
- など

すべてをAWSマネジメントコンソールやAPIを使って設定したり確認したりできるからです。

APIを利用してネットワークの構築や設定が出来るという事は、ChefやPuppetのデプロイツールでさーばーの構成のみならず、ネットワークの構成も作れるということを意味します。
一度設定ファイルを作っておけば、同じ厚生のネットワークをいくつも作るのは簡単
→これなら毎年AWSを個人のアカウント作って使いまわせるのでは？  
→ZENPEN Web サイトを簡単に移行できる！！！！  


さらに、設定ファイルをバージョン管理しておけば、差分を撮ることで、どの時点でどの変更をしたか？が簡単にわかります。
万一設定に間違いがあった場合でも、元に戻すの容易です。


設定ファイル及びAPIコールのスクリプトやアプリケーションは自分で開発することも可能だが、
**AWS CloudFormation**というAWSのサービスを使えばOK.

CloudFormationはEC2やVPCなどの各種リソ0すをJSON形式のテンプレートとして定義し、それを元にリソースをデプロイしてくれるサービス。

このようなデプロイのためのツールを上手く使えば、構成情報と構築の手順を誰でも分かるようにしておくことは、とても重要です。

**最新の情報を簡単に確認でき、誰でも同じものを簡単に作れるという環境を目指すこと**で、安定した運用を望めます。。。

→これだよこれ。学生団体とか、一年周期で担当者が代わるので、自分のサーバとかに入れたりすると、移行が大変で死ぬ。

→cloudformationの使い方がいまいちわからないのでよろしくです。

#### ネットワークの状態の把握

##### pingを使った疎通確認

pingは疎通確認に使うコマンドです。
サーバーの死活確認にも使われますね。

pingコマンドはICMPプロトコルを利用しているので、セキュリティグループやファイアウォールでICMPを通す設定にする必要が有ります。

Internet Control Message Protocol。

##### tracerouteコマンドでの経路確認

tracerouteコマンドは、ping同様にICMPを使ったコマンドです。
宛先へのネットワーク上の経路を確認するときに利用するコマンドです。

**実際に試してみましょう**

```
saturn3486PC:aws_test saturn3486$ traceroute titech.ac.jp
traceroute to titech.ac.jp (131.112.125.17), 64 hops max, 52 byte packets
 1  buffalo.setup (192.168.11.1)  1.848 ms  1.390 ms  1.175 ms
 2  * * *
 3  210.236.165.1 (210.236.165.1)  11.531 ms  9.349 ms  9.521 ms
 4  210.236.165.37 (210.236.165.37)  11.462 ms  11.085 ms  12.287 ms
 5  61.198.53.82 (61.198.53.82)  18.112 ms  18.236 ms  19.030 ms
 6  as2907.ix.jpix.ad.jp (210.171.224.150)  16.935 ms  16.233 ms  18.923 ms
 7  tokyo-dc-rm-ae4-vlan10.s4.sinet.ad.jp (150.99.2.53)  20.654 ms  17.726 ms  20.038 ms
 8  titech.gw.sinet.ad.jp (150.99.186.230)  22.059 ms  46.629 ms  39.658 ms
 9  131.112.255.217 (131.112.255.217)  24.475 ms  22.852 ms  23.937 ms
10  ns1.noc.titech.ac.jp (131.112.125.17)  17.555 ms  19.980 ms  22.205 ms
```
東工大まで結構色々経由してるんですね。

```
saturn3486PC:aws_test saturn3486$ traceroute www.titech.ac.jp
traceroute to www.titech.ac.jp (49.212.234.52), 64 hops max, 52 byte packets
 1  buffalo.setup (192.168.11.1)  1.643 ms  1.332 ms  1.272 ms
 2  * * *
 3  210.236.165.169 (210.236.165.169)  11.038 ms  13.308 ms  12.004 ms
 4  210.236.165.38 (210.236.165.38)  14.800 ms  10.092 ms  9.400 ms
 5  103.246.232.113 (103.246.232.113)  14.849 ms  15.459 ms  21.025 ms
 6  oshrt1s-hrt3-1.bb.sakura.ad.jp (157.17.146.130)  14.207 ms
    osnrt1s-hrt3-1.bb.sakura.ad.jp (157.17.146.122)  16.000 ms
    oshrt1s-hrt3-2.bb.sakura.ad.jp (157.17.146.134)  16.514 ms
 7  oshrt2b-nrt1s.bb.sakura.ad.jp (59.106.244.158)  14.677 ms
    oshrt2b-hrt1s.bb.sakura.ad.jp (157.17.146.150)  14.138 ms
    oshrt2b-nrt1s.bb.sakura.ad.jp (59.106.244.158)  15.533 ms
 8  oshrt24e-hrt2b.bb.sakura.ad.jp (157.17.155.6)  15.602 ms
    oshrt24e-hrt1b.bb.sakura.ad.jp (157.17.154.6)  13.670 ms
    oshrt24e-hrt2b.bb.sakura.ad.jp (157.17.155.6)  14.456 ms
 9  www10038ug.sakura.ne.jp (49.212.234.52)  16.070 ms !Z  14.648 ms !Z  13.386 ms !Z

```
!Zは、どうやらICMPが禁止になってるところらしい。
ていうかsakuraのサーバーめっちゃ通ってるね。

##### ポート番号を指定したTCP到達性の確認

pingで確認できるのは、ICMPを使ったネットワーク到達性です。
時には特定のポートへの到達性を確認したい頃が有ります。
例えばネットワーク自体はpingコマンドで到達性を確認できているけど、Webサーバーのミドルウェアが起動しているのか？もしくはファイアウォールやセキュリティグループで通信が妨げられてないかを確認したい時です。

このようなときは、telnetコマンドを使います。

`telnet host_name port_number`で実行


ポート番号を省略した時は、telnetのウェルノウンポート23番がデフォルトで使用されます。


##### nslookupやdigでの名前解決の確認

名前解決リクエストを送信するコマンド

```
saturn3486PC:aws_test saturn3486$ nslookup www.titech.ac.jp
Server:   192.168.11.1
Address:  192.168.11.1#53

Non-authoritative answer:
Name: www.titech.ac.jp
Address: 49.212.234.52
```

簡単に分かる。
`Non-authoritative answer:`の表記は、権威DNSサーバーではなく、キャッシュDNSサーバーからの応答を示す。

**権威DNSサーバーはそのネットワークの情報を保持しているDNSサーバーの事。**

digコマンドの使い方も同様。


```
saturn3486PC:aws_test saturn3486$ dig www.titech.ac.jp

; <<>> DiG 9.8.3-P1 <<>> www.titech.ac.jp
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22073
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 2

;; QUESTION SECTION:
;www.titech.ac.jp.    IN  A

;; ANSWER SECTION:
www.titech.ac.jp. 376 IN  A 49.212.234.52

;; AUTHORITY SECTION:
titech.ac.jp.   6859  IN  NS  ns2.noc.titech.ac.jp.
titech.ac.jp.   6859  IN  NS  ns1.noc.titech.ac.jp.
titech.ac.jp.   6859  IN  NS  ns.fujisawa.wide.ad.jp.

;; ADDITIONAL SECTION:
ns1.noc.titech.ac.jp. 66698 IN  A 131.112.125.17
ns2.noc.titech.ac.jp. 2225  IN  A 131.112.125.18

;; Query time: 34 msec
;; SERVER: 192.168.11.1#53(192.168.11.1)
;; WHEN: Tue Dec 29 15:39:35 2015
;; MSG SIZE  rcvd: 156
```

コッチは、より詳細な情報が得られたりします。

#### ウェブサイトへ接続出来ない時の対処方法

1. 自身のネットワーク環境の確認  
対象のホスト以外に適当に接続してみて、問題ないことを確認する。
1. 名前解決の確認  
nslookupコマンドやdigコマンドで、対象のホスト名が解決されていることを確認。
もし出来なければ、DNSの設定や、DNS自体に問題有り。
1. pingコマンドでのネットワークの疎通の調査。
DNSに問題がないなら、pingコマンドでネットワークの疎通確認  
pingコマンドが通らなかった場合、途中のネットワークに問題が有るか、Webサーバーが死んでいる可能性が有ります。
ただし、ICMPが通らない設定の場合もあるので、あしからず。  
1. telnetコマンドでポート80番に接続する。
次に、telnetでHTTPのウェルノウンポートである80番に接続する。
もし応答がなければポート80番がセキュリティの設定などに酔って閉じられている、もしくは、ApacheなどのHTTPサーバーのプロセスが起動してない、ということが考えられます。

上記のすべてを確認して、それでも、Webサイトに接続できない時は、おそらくアプリケーション内部の問題だと考えられます。


tracerouteコマンドは使用しませんでしたが、tracerouteはルーティングの設定の確認に使われることがほとんどです。
Webサーバーのトラブルではあまり利用しません。

#### ネットワーク運用ツール

- Zabbix  
オープンソースのシステム監視ソフトウェア
- New Relic  
SaaS型のモニタリングサービス  
サーバー監視に特化しており、エージェントをインストールするだけですぐに使い始められます。
- CloudWatch  
AWSが提供するモニタリングサービス。
一番の特徴はAWSの各サービスの情報を得られることです。

## まとめ

ネットワークは全てのシステムの基盤となる部分です。
しっかりと出来るだけ手間なく運用出来る様に心がけましょう。
