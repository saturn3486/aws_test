# 触って学ぶクラウドインフラAWS　Chapter3

## サーバーを構築する。


Amazon EC2のインスタンスをパブリックサブネット内に作製。  
このサーバーには、後々Apacheを導入して、Webサーバーとして活躍してもらう予定。

このインスタンスに、プライベートIPアドレスを割り当てる。  
パブリックサブネットのCIDRブロックは(`10.0.1.0/24`)なので`10.0.1.0~10.0.1.255`まで入る。  

しかし、プライベートIPアドレスでは、インターネットには接続できないので、パブリックIPアドレスも割り当てられます。

### インスタンスを作製する。

1. AWSマネジメントコンソールのEC2を開く
1. 左メニューからインスタンスを選択
1. インスタンスの作成をクリック
1. Amazon Linux AMIを選択（OSがインストールされ、初期アカウントの追加まで終わってる状態。）
1. （2015/12/26現在）t2.microが無料の対象なので、コイツを選択
1. インスタンスの詳細の設定を選択
1. ネットワーク「VPC領域」、サブネット「パブリックサブネット」を選択
1. 自動割当パブリックIPで、「有効化」
1. ネットワークインターフェースのプライマリIPのところで、ここで「`10.0.1.10`」を指定。適当。
1. 次の手順:ストレージの追加をクリック
1. 練習なので、デフォルト設定で行く。次の手順へ。
1. インスタンスの名前を付ける。Webサーバとして使うので、そのまま`Webサーバ`。次の手順へ。
1. インスタンスに対してセキュリティを設定するセキュリティグループ。
1. セキュリティグループ名を`WEB-SG`にして次へ。→現状でSSHでどこからでもアクセス出来る設定だけど、普通は自社のIPだったり、ある程度制限をかける。
1. 作成をクリック。
1. キーペアの設定を行う。
1. 新しいキーペアの作成をドロップダウンボックスから選択
1. キーペア名には、適当に「my-key」とか。
1. キーペアのダウンロードをクリック
1. キーペアがダウンロードされる。このキーペアは一生復活させられないので、絶対紛失しないように。
1. インスタンスの作成をクリック
1. 右下のインスタンスの表示をクリック→（running）動いている事を確認！やったね！

### SSHで接続する！

とうとうここまで来たか。
俺のサーバが手に入ったぜへっへっへ。

1. パブリックIPアドレスを確認する。
    1. 左のインスタンスを選択
    2. さっき作ったやつを選択
    3. 下のメニューからパブリックIPアドレスを確認
    4. `52.192.87.75`だった。
1. terminalを開く
1. my-key.pemのあるフォルダへ。
1. `ssh -i my-key.pem ec2-user@52.192.87.75`を実行
1. なんか鍵のファイルのパーミッションが厳しくないので怒られた。
1. `chmod 400 my-key.pem`実行
1. もう一回`ssh -i my-key.pem ec2-user@52.192.87.75`を実行
1. `Are you sure you want to continue connecting (yes/no)?`→yes
1. 接続出来ました！

パブリックIPアドレスは、再起動とかすると、変わっちゃうので、固定IPにするのも有り。  

#### パブリックIPアドレスを固定する方法

1. 左のメニュー、ネットワーク＆セキュリティのElastic IPを選択
1. 新しいアドレスの割当を選択
1. VPC選択して、割り当てる。
1. EC2インスタンスを選択
1. 結びつける。

### IPアドレスとポート番号

SSH接続で、サーバーにログインして、各種コマンドを実行できるわけですが、
なんでこんなことが出来るのか・・・

ちょっと深く探って見ましょう。

#### パケットを相手に届けるルーティングプロトコル。

SSHでは、接続時に相手のパブリックIPアドレスを入力した。
このアドレスを元に、ルーターからルーターへこちらからのパケットがバケツリレーのように渡されていくわけです。

では、なぜルーターは新しく生成されたEC2インスタンスの場所が分かるのでしょうか？

追加したルーティングテーブルはAmazonのだけ。

なぜ大学内のルーターはそこに届ければ届くと分かったのか？

ソレは、ルーター同士がルートテーブルの情報を自分自身でやりとりしているのです！

代表的な方法を2つ。

1. EGP（Exterior Gateway Protocol）  
ISP（internet service provider）やAWSなどのある程度大きなネットワークでは、そのネットワークを管理するAS番号という番号がある。
このAS番号をやり取りして、だいたいあのネットワークの奥に目的のネットワークがある、とおおまかなやり取りをします。


2. IGP（Interior Gateway Protocol）  
上記のEGP内のルーター同士で、ルートテーブルの情報をやり取りします。プロバイダーだったりAWSの中の詳細なやりとりです。



なお、EGPやIGPはルーティング情報交換プロトコルの総称。
実際には、EGPではBGP、Bordor Gateway Protocolが使われる。  
IGPも同様に、OSPF,Open Shortest Path First、RIP、Routing Information Protocolなどが使われる。

#### サーバー側のサービスとポート番号の関係。

ユーザー認証とかが行われ、サーバーを操作出来るようになるのは何故か？というかなぜそのように動くか？

内部で　`sshd` というプログラムが働いているからさ。
Amazon Linuxではサーバー起動と同時にsshdが動くらしい。

サーバー内部には、他のコンピュータとデータを送受信するためのデータの出入り口が用意されている。
その出入り口がポートなわけです。


色んなソフトがサーバと言うマンションに住んでいるとして、部屋番号で出てくるソフトが違うって感じですかね。


ポートには、「相手にデータが届いたことを保証するTCP(Transmission Control Protocol)」と「確認せずに送信するUDP（User Datagram Protocol）」が有る。

##### 待ち受けているポート番号とプログラムを確認する。

EC2インスタンスにSSH接続したあと、terminalで`sudo lsof -i -n -P`を実行すると、ポート番号とそれに対応しているプログラムが確認できる。

(LISTEN)ってなってるのは待ち状態。(ESTABLISHED)が現在通信中のポート。

```bash
COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
dhclient  1982     root    5u  IPv4   8825      0t0  UDP *:68 
rpcbind   2071      rpc    6u  IPv4   9140      0t0  UDP *:111 
rpcbind   2071      rpc    7u  IPv4   9141      0t0  UDP *:974 
rpcbind   2071      rpc    8u  IPv4   9142      0t0  TCP *:111 (LISTEN)
rpcbind   2071      rpc    9u  IPv6   9143      0t0  UDP *:111 
rpcbind   2071      rpc   10u  IPv6   9144      0t0  UDP *:974 
rpcbind   2071      rpc   11u  IPv6   9145      0t0  TCP *:111 (LISTEN)
rpc.statd 2088  rpcuser    7u  IPv4   9226      0t0  UDP *:52063 
rpc.statd 2088  rpcuser    8u  IPv4   9229      0t0  TCP *:60105 (LISTEN)
rpc.statd 2088  rpcuser    9u  IPv6   9232      0t0  UDP *:46985 
rpc.statd 2088  rpcuser   10u  IPv6   9235      0t0  TCP *:44696 (LISTEN)
rpc.statd 2088  rpcuser   15u  IPv4   9223      0t0  UDP 127.0.0.1:1001 
sshd      2295     root    3u  IPv4   9823      0t0  TCP *:22 (LISTEN)
sshd      2295     root    4u  IPv6   9825      0t0  TCP *:22 (LISTEN)
ntpd      2319      ntp   16u  IPv4   9899      0t0  UDP *:123 
ntpd      2319      ntp   17u  IPv4   9903      0t0  UDP 127.0.0.1:123 
ntpd      2319      ntp   18u  IPv4   9904      0t0  UDP 10.0.1.10:123 
sendmail  2334     root    4u  IPv4   9970      0t0  TCP 127.0.0.1:25 (LISTEN)
sshd      2430     root    3u  IPv4  10410      0t0  TCP 10.0.1.10:22->131.112.198.156:56226 (ESTABLISHED)
sshd      2432 ec2-user    3u  IPv4  10410      0t0  TCP 10.0.1.10:22->131.112.198.156:56226 (ESTABLISHED)
```

ここでちょっとsendmailに注目してみると、LISTEN状態。
接続元は、`127.0.0.1`と成っている。これはループバックアドレスと呼ばれる、自分の事。他のアドレスからは受け付けませんよ状態。


SSHはポート番号22番がよく使われる。

こんな感じで良く使用されるのはウェルノウンポートとか呼ばれる。
HTTPの80番とか有名だよね。

ちなみに、

```
sshd      2432 ec2-user    3u  IPv4  10410      0t0  TCP 10.0.1.10:22->131.112.198.156:56226 (ESTABLISHED)
```

の`10.0.1.10:22->131.112.198.156:56226`は相手と自分のことね。terminalはどうやら56226のポートを開けてるらしい。


### ファイアウォールで接続制限！


ファイアウォールは、通して良いデータだけ通してそれ以外を遮断する機能、の総称。  
その最も簡単なものが、パケットフィルタリングです。

#### パケットフィルタリング

パケットフィルタリングは、流れるパケットを見て、通過の可否を決める仕組み

IPアドレスとか、ポート番号がパケットには含まれているので、それを確認して、通過の可否を決定する。

デフォルトのポート番号などは、誰かに勝手に使われるのでコワイ！なので、MySQLの3306番とかは使うのやめたりと、
セキュリティ面で役に立ちます。

#### インスタンスのセキュリティグループ

実世界でそのパケットフィルタリングをしているのは、ルーターやサーバー、もしくは専用のファイアウォール機器なわけです。
ルーターに、55330番のポートが来たら、3306番に届ける、3306番に来たのは破棄！とかそんなことしたな〜〜〜。

AWSでは、インスタンスに対して構成する「セキュリティグループ」がこの機能を担当します、


デフォルトの構成では、ポート22の全ての通信を許可。


これから、必要に応じて、セキュリティグループの構成を変更していきます。

セキュリティグループには、インバウンド、外からコッチに向いて入ってくるやつ。アウトバウンド、こっちから外に向かうやつ。の両方がある。

ここでは、外部から不正な操作をされないように、その接続を阻む目的なので、インバウンドの設定をおこないます。

しかし、実際には、自分のサーバから、外部のPCに接続しないようにとアウトバウンドの設定も行います。

### まとめ。

パブリックサブネット内に1台のサーバー（インスタンス）を配置しました。
作成したインスタンスには、プライベートIPアドレスを設定し、パブリックIPアドレスも自動で設定されました！

そしてそのアドレスを元に、SSH接続する方法も説明しました。

その操作のなかで　、次の事も説明しました。

- ルーティング情報のやりとり

- ポート

- パケットフィルタリングとセキュリティグループ



次の章では、このインスタンスにWebサーバーソフトをインストールして、Webサーバーとして動作させます！

乞うご期待！
