# chapter 2 ネットワークの構築

ここでVPCを構成。
その前に、AWSのアカウントを作製。

日本語に設定して、適当に情報を入力。
個人用で、日本語なのに、英語の住所っぽく記入。

その後、クレジットカード番号を設定して、
なんか電話番号で本人確認→PINコード入力。

→マネジメントコンソールへログイン。

準備OK！


## ネットワークで用いるIPアドレス範囲を定める

VPCを作製するまえに、IPアドレス範囲を考える。
TCP/IP（Transmission Control Protocol/Internet Protocol）ではIPアドレスで通信先を特定。
IPv4バージョンしか本に載ってなかったので、もしIPv6なら適当に頑張る。

インターネットで利用できるIPアドレスは
ICANN（Internet Corporation for Assigned Names and Numbers）という団体が管理。


#### パブリックIPアドレスとプライベートIPアドレス


パブリックIPアドレスとかグローバルIPアドレスとか言うけど、ここでは、パブリックに統一。

JPNICとかAPNICとか上位団体にプロバイダーはIPアドレスを申請して、もらうことが出来る

一方プライベートIPアドレスは自由に使ってOK。
これはLANで使うね。

#### IPアドレス範囲と表記方法

IPアドレス範囲は勿論2の◯乗個。

IPアドレスは二部に別れ、片方はネットワーク部、もう片方は、ホスト部。


#### CIDR表記とサブネットマスク表記

CIDR（サイダー　Classical Inter-Domain Routing）表記、もしくはサブネットマスク表記を用いる。


- CIDR 表記

IPアドレスを2進数で表した時のネットワーク部のビット長を「/ビット長」で表すモノ。
`192.168.11.0/24`とかよく見るよね。
このビット長をプレフィック長とか言います。

- サブネットマスク表記

`192.168.11.0/255.255.255.0`とか。

## 実験用VPCを作製する！

VPCではプレフィックス長として16以上がもとめられる。　
ここでは、
`10.0.0.0/16`のCIDRブロックを使用
を使う。

ここから、AWSを使っていくぜ〜〜

この工程が、ハブとか使って、接続している時だね。

-----------

#### AWSマネジメントコンソールからの手順

1. AWSマネジメントコンソールでVPCを開く  
よゆーよゆー
2. リージョンを設定する  
？？？→リージョン自体は、右上の「サポート」の隣のドロップダウンメニューから「アジア・パシフィック（東京）」を選択
既にオレゴンのリージョンのVPCが稼働中。。。
どうしよう。。  
EC2インスタンスも立ち上がってるっぽい。  
とりあえず金掛かるの嫌だから、消したいな〜。  
EC2インスタンスを立ち上げるときに、コッチのVPCのインスタンス止めればOKじゃないかな。。。。  
というわけで、放置！  
3. 左のメニューからVPCを選択
4. VPCの作製をクリック
5. ネームタグには「VPC領域」、CIDRブロックには`10.0.0.0/16`。  
テナンシーって何？
    >ハードウェア専有インスタンス
    >
    >ハードウェア専有インスタンスは、単一のカスタマー専用のハードウェアの Virtual Private Cloud（VPC）で実行される Amazon EC2 インスタンスです。ハードウェア専有インスタンスは、ハードウェア専有インスタンス以外のインスタンスや、他の AWSアカウントに属するインスタンスとは、ホストハードウェアのレベルで物理的に分離されます。
何か`VPC全体で同じハードウェアを占有する`って事が出来るっぽい？他のユーザーの仮想サーバが載ってこないんだね。金かかるのか。。無理！
6. テナンシー＝デフォルトでOK！作製をクリック。

## VPCをサブネットに分割する。

プライベトなネットワーク空間が完成。
次に、このネットワークを小さなCIDRブロックに分割して、サブネットを作製。
これをプライベートにしたり、パブリックにしたり、セキュリティのために色々分ける。


よく使われるのが、この`10.0.0.0/16`から`10.0.0.0/24`と細かいCIDRブロックにわけて、256分割。

分けたい理由あるある。
1. 物理的な隔離  社内LANとかで、1Fと2Fでサブネット分けたい。ってなる。片方の障害がもう片方に影響を及ぼさないとか。対障害性UP。
1. セキュリティ上の理由  サブネットを分ければそれに対して、別のネットワークの設定が可能。「経理部のデータにはアクセス出来ないように。」とか。

### さあ実際にVPC領域をサブネットに分割しよう。

一個目のサブネット（`10.0.1.0/24`）を、パブリックサブネット(Webサーバーとかおく。)  
二個目のサブネット（`10.0.2.0/24`）を、プライベートサブネット(DBサーバーとかおく。)

としよう。

#### AWSマネジメントコンソールからの手順

1. 左のメニューから、サブネットをクリック。
1. サブネットの作製をクリック
1. ネームタグは「パブリックサブネット」、VPCは「VPC領域」。。。。あれ？東京リージョンに設定するのってどこからだ！？  ここで一回戻る。
1. 次はアベイラビリティゾーンで1aを選択。良く見るこのドメインは東京リージョンだったのね。→指定なしでもOKですよ。


何とか完成。


## インターネット回線とルーティング

まずは、このパブリックサブbネットをインターネットに接続する。
インターネットゲートウェイ（ルーター）を設置する必要がある。

自分のネットワークにインターネット回線を引き込む作業。

#### AWSマネジメントコンソールからの手順

1. 左メニューからインターネットゲートウェイを選択
1. インターネットゲートウェイの作製を選択
1. ネームタグは、複数運用する場合は、どのサブネットのものかわかりやすいので良いと思います。  でもめんどいのでココではスルー。
1. dettachedっていうパラメータを持った奴が完成。
1. 作製したインターネットゲートウェイにチェック。
1. 上のVPCにアタッチを選択
1. 先ほどのVPCを選択
1. attachedに成っていることを確認。


スムーズ。

### ルーティング。

ネットワークにデータを流すためには、ルーティング情報が必要。
ルーティングテーブルとかルートテーブルとか言うけど、AWSではルートテーブルッて言われてる。

ルートテーブルには、  
宛先アドレス＋流すべきネットワークの入り口のルータ  
という情報が格納されている。
流すべきネットワーク先の事を、「next hop」「target」とか言います。
AWSではターゲット。

コイツを今から設定して上げます。


### Amazon VPCでルートテーブルを設定。

AmazonVPCでは、サブネットごとにルートテーブルを設定出来る（ルータじゃない！！！）  
実際には、サブネットとインターネットゲートウェイの間に、ルーターの役割を果たすソフトが稼働してるっぽい。

#### AWSマネジメントコンソールからの手順（ひとまず今の状態を確認）

1. 左のメニューからサブネットを選択
1. サブネットのパラメータの中に、ルートテーブルがあるので、確認。`rtb-xxx`とか書いてある。。。
1. 次に左のメニューからルートテーブルを選択
1. さっきのIDを持つルートテーブルを選択
1. 下のタブからルートを選択して、中身を確認  

|送信先|ターゲット|ステータス|伝達済み|  
|---|---|---|---|  
|10.0.0.0/16|local|アクティブ|いいえ|  

これだと、`10.0.0.0/16`この送信先以外は全部破棄になる。


#### いまからネットワークと繋げてあげる。

パブリックサブネットでは、どんなパケットを受け取っても、インターネットへ流す。（デフォルトゲートウェイ）の設定を行う。  
まあ`0.0.0.0/0`の宛先には、インターネットゲートウェイへ流す様にするだけ。

1. ルートテーブルの作製を選択
1. ネームタグ「パブリックルートテーブル」、VPCはもちろんVPC領域。それで作製
1. 下のタブからルートを選択
1. 編集、別のルートを追加をクリック
1. 送信先は　`0.0.0.0/0`、ターゲットには、`igw-`から始まるインターネットゲートウェイを選択。
1. ルートテーブルの完成。サブネットとの関連付けを行う。
1. 下のタブからサブネットの関連付けを選択
1. 編集をクリック
1. パブリックサブネットを選択して保存
1. 左メニューのサブネットから、パブリックサブネットを確認し、ルートテーブルが正しいかを確認。

## ここまでのまとめ

プライベートネットワーク空間のVPCをサブネットに分割。  
それぞれのサブネットはインターネットに接続しない、プライベートなものと、反対に公開されるパブリックなもの。  
そのために、片方のルートテーブルは、インターネットゲートウェイにデフォルトゲートウェイを当てはめ、サブネットに関連付けた。


次の章では、今回構築した、パブリックサブネット内に、1台の仮想サーバーを追加してあげます！


乞うご期待！


