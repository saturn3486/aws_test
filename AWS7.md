## 触って学ぶクラウドインフラAWS　Chapter7

前回はプライベートサブネットを作成し、その中にDBサーバー用にインスタンスを作成。

WEBサーバを踏み台にしてSSH接続出来るようになりました！

次は、DBサーバーからインターネットへ接続してMySQLやOSのアップデートなど、インターネットに接続するためのNATサーバーを構築します。

## NATサーバー

#### 仕組み

NATサーバーはIPアドレスを変換するサーバーで、2つのネットサークのインターフェースを持ちます。
片側のインターフェースには、一般にパブリックIPアドレスを設定し、インターネットに接続可能な構成にしておきます。
そして、もう片側のインターフェースには、プライベートIPアドレスを設定し、プライベートサブネットに接続します。
プライベートサブネット内のホストが、インターネットにパケットを送信しようと知っとき、NATはパケットの送信元IPアドレスを自身のパブリックIPアドレスに置換します。

これによって、送信元がプライベートIPアドレスではなくNATサーバーが持つパブリックIPアドレスに変換されるため、インターネとに出て行くことが出来る。

ちなみに、IPアドレスだけを置換するものと、IPアドレスとポート番号を置換するものと、2種類のNATが有ります。
前者はNAT,後者はNAPT（Network Address and Port Translaltion）やIPマスカレードと呼ばれる。

でもここでは共通してNATと呼ぶ。

NAPTだと、1つのパブリックIPアドレスを沢山のPCで共有可能。

家庭内のルーターもNATの役割を担っていたりします。

#### プライベートサブネットとパブリックサブネットをNATで接続する。

1. パブリックサブネットにNATサーバーを配置。
AWSには、NATサーバー機能が搭載されたAMIを選択可能。
NATサーバーには、パブリックサブネットのCIDRだったら何でもよし。ここでは`10.0.2.20`にしよう。
1. NATサーバーのセキュリティグループを構成する。
適切なファイアウォールを設定したセキュリティグループを設定します。
基本的にDBサーバーで利用するのは、yumコマンド`yum update`とか`yum install`だけなので、httpとhttpsのポート80,443しか開放しません。
1. デフォルトゲートウェイを設定する。
プライベートネットワークからのパケットが、NATサーバーを経由するように設定する。

#### NATサーバーのセキュリティグループ

1. ポート80番と、443番だけ通す。  
yumコマンドは、http通信とhttps通信のみなので、これを**インバウンド**で通す。  
これは、プライベートサブネット（DBサーバー）からパブリックサブネット（NATサーバ）への送信。
そして、**アウトバウンド**として、80番と443番だけ通す。→送信先は、yumコマンドでどこになるか分からないし任意のホストでOK。
今まではアウトバウンドは制限が無かったが、ここは通す。完全にNATサーバー、DBサーバの間は、http,httpsの通信しか開かない。
1. ポート22番のインバウンドを10.0.1.10の送信元だけ許可する。  
sshは、WEBサーバの踏み台SSHだけOKとする設定。


#### 実際にやってみよう


1. AWSのEC2→セキュリティグループへ移動。
1. セキュリティグループの作成を選択
1. NAT-SGって感じの名前
1. インバウンドhttpとhttpsで、送信元は、プライベートネットワーク内の任意のホスト（`10.0.2.0/24`）
1. インバウンドでSSH、送信元は、Webサーバーからだけ。(`10.0.1.10/32`)
1. アウトバウンドで、httpとhttpsだけ通す。


#### ステートレスとステートフルのファイアウォール。

- ステートレスのファイアウォール

流れるパケットの前後関係は見ない。そのパケットだけで判断する。


- ステートフルのファイアウォール

幾つかのパケットを保存しておいて、それらのパケットを判断材料に。


ステートレスの方が高速に通信可能ですが、詳細な条件でパケットフィルタリングすることができません。
逆にステートフルだと細かい条件を設定することが可能ですが、低速になります。

AWSのEC2のファイアウォールだと、セミステートフルになっており、TCP通信ならば、ステートフルのファイアウォールが効きます。
FTP通信などもステートフルにしたい場合は、EC2インスタンス側にそれ専用にファイアウォールソフトをインストールする必要が有ります。


#### NATインスタンスを作成する！

1. AWSからEC2に行き、インスタンスの作成を選択。
1. いつもAmazon Linux AMIを選んでいたところで、左のメニューからコミュニティAMIを選択。
1. 検索ボックスから、「ami-vpc-nat」を検索。
1. 色々結果は出てきたが、最新のやつを選択（`mzn-ami-vpc-nat-hvm-2015.03.0.x86_64-gp2 - ami-03cf3903`）
hvmとpvは仮想化度合いの違いらしい。[ここ](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/virtualization_types.html)を参考に``を選択。
1. t2.microを選択
1. VPC領域の、パブリックサブネットを選択。
1. パブリックIPアドレスはもちろん有効化、プライベートIPアドレスとして（10.0.1.20）を割り当てとく。
1. ストレージはデフォルト。
1. 名前はNATサーバー
1. 先ほど作成したセキュリティグループ（NAT-SG）を選択
1. 先へ進める。
1. 完成！！！

#### 送信元/送信先のチェックを外す。

EC2インスタンスはデフォルトの設定で、「パケットを受け取るには、そのインスタンスが送受信するトラフィックの送信元または送信先である」という条件が課せられてる。
偽装パケットとかのための対策なんだけど、NATに限ってはこれを外しちゃいます。

1. AWSからNATサーバインスタンスを選択
1. アクションからネットワーキング→送信元/送信先の変更チェック→はい、無効化します。
1. `送信元/送信先チェック False`を確認。

#### ルートテーブルを更新する。

これでNATサーバーが起動して動作するようになりました！

次は、プライベートサブネットのパケットがNATサーバーへ流れるようにしてあげます。
今までは、ローカルに流すだけだったしね〜。

1. NATサーバのインスタンスIDを確認→`インスタンス ID i-2db1f788`
1. AWSのVPC→サブネットへ。
1. ルートテーブルへ移動
1. VPC領域のルートテーブルでメインになっているものを選択。
1. ルートタブをひらいて、ネットへの送信（0.0.0.0/0）をNATサーバー（`インスタンス ID i-2db1f788`）へ流す様に設定。→保存。

## NATサーバーを経由した疎通確認を行う！

以上でNATサーバーの設置が完了しました！
NATサーバーを経由してネットにつながってるかテストやってみましょう。

これは、以前使用したtelnetコマンドでも行う事が出来ます。
しかし、Amazon Linux AMIにはデフォルトでtelnetが入ってるわけではないので、ここではcurlコマンドを使用します。

curlコマンドはHTTPやFTPを使って、ファイルをファイルをダウンロードしたりアップロードしたりするコマンドです。

#### 実際にやってみよう。

1. SSHでDBサーバーへアクセス。
1. `curl www.google.co.jp`→googleのHTMLが取得出来る。
```
[ec2-user@ip-10-0-2-10 ~]$ curl www.google.co.jp
<!doctype html><html itemscope="" itemtype="http://schema.org/WebPage" lang="ja"><head><meta 
...
略
```
NATサーバーを止めて同じ事をやってみる。
```
[ec2-user@ip-10-0-2-10 ~]$ curl www.nikkeibp.co.jp
curl: (7) Failed to connect to www.nikkeibp.co.jp port 80: 接続がタイムアウトしました
```


## まとめ

今回は、NATサーバーを構築して、プラベートネットワークに有るサーバーからインターネットへの接続を可能にしました！

しかもインターネットからはプライベートネットワークに有るサーバーには直接接続出来ないため、セキュリティ的にもバッチリ！

パブリックIPなんて割り当てようものならガンガン攻撃来るんだろうな〜〜。

ではでは、次回はNATサーバーによってDBサーバーでyumコマンドを唱える事が可能になったので、MySQLをDBサーバーにインストールします！

そしてWebサーバにはWordpressをインストール。

とうとうブログサーバーとして運用する所までやって来ました！！！


乞うご期待！



